name: Sync Upstream and Apply Modifications

on:
  workflow_dispatch: {}  # æ‰‹åŠ¨è§¦å‘ï¼šå¼ºåˆ¶æ‰§è¡Œ
  schedule:
    - cron: '0 15 * * *'  # å®šæ—¶è§¦å‘ï¼šæ£€æµ‹ä¸Šæ¸¸æ›´æ–°
  push:
    branches:
      - main
    paths:
      - '.github/workflows/mydiywode.yml'  # ä»…å½“æ­¤æ–‡ä»¶å˜åŒ–æ—¶è§¦å‘

permissions:
  contents: write
  actions: write

jobs:
  sync-and-modify:
    runs-on: ubuntu-latest
    env:
      REPO: ${{ github.repository }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN != '' && secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set up upstream remote
        run: |
          git remote add upstream https://github.com/ysuolmai/OpenWRT-CI.git 2>/dev/null || true
          git remote -v

      - name: Fetch upstream and origin branches
        run: |
          echo "æ­£åœ¨ä»ä¸Šæ¸¸ä¸ origin æ‹‰å–æœ€æ–°åˆ†æ”¯..."
          git fetch upstream main --prune
          git fetch origin main --prune

      - name: æ‰‹åŠ¨è§¦å‘æç¤º
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "::notice::æ‰‹åŠ¨è§¦å‘æ‰§è¡Œ - å°†å¼ºåˆ¶åŒæ­¥ä¸Šæ¸¸å¹¶åº”ç”¨è‡ªå®šä¹‰ä¿®æ”¹"

      - name: Check for upstream updates
        id: check_updates
        run: |
          UPSTREAM_REF="refs/remotes/upstream/main"
          ORIGIN_REF="refs/remotes/origin/main"

          UPSTREAM_HEAD=$(git rev-parse --verify ${UPSTREAM_REF} 2>/dev/null || echo "")
          ORIGIN_HEAD=$(git rev-parse --verify ${ORIGIN_REF} 2>/dev/null || echo "")

          echo "ä¸Šæ¸¸ HEAD: $UPSTREAM_HEAD"
          echo "origin/main HEAD: $ORIGIN_HEAD"

          # å¦‚æœæ— æ³•è·å–ä¸Šæ¸¸å¼•ç”¨ï¼Œæ ‡è®°ä¸ºæ— æ›´æ–°
          if [ -z "$UPSTREAM_HEAD" ]; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "::warning::æ— æ³•è¯»å– upstream/main å¼•ç”¨"
            exit 0
          fi

          # è®¡ç®—ä¸Šæ¸¸é¢†å…ˆçš„æäº¤æ•°
          COMMITS_AHEAD=$(git rev-list --count ${ORIGIN_REF}..${UPSTREAM_REF} 2>/dev/null || echo 0)
          echo "ä¸Šæ¸¸ç›¸å¯¹äº origin/main æ–°å¢æäº¤æ•°: $COMMITS_AHEAD"

          if [ "$COMMITS_AHEAD" -gt 0 ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "::notice::å‘ç°ä¸Šæ¸¸æ–°æäº¤ï¼ˆ${COMMITS_AHEAD} ä¸ªï¼‰"
            echo "æœ€æ–°çš„ä¸Šæ¸¸æäº¤ï¼š"
            git --no-pager log --oneline ${ORIGIN_REF}..${UPSTREAM_REF} --max-count=5 || true
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "::notice::ä¸Šæ¸¸æ— æ–°æäº¤ï¼Œæ— éœ€åŒæ­¥"
          fi

      # å†³å®šæ˜¯å¦æ‰§è¡Œåç»­æ­¥éª¤
      - name: Determine if should proceed
        id: should_proceed
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "proceed=true" >> $GITHUB_OUTPUT
            echo "::notice::æ‰‹åŠ¨è§¦å‘ - å¼ºåˆ¶æ‰§è¡Œ"
          elif [ "${{ steps.check_updates.outputs.has_updates }}" = "true" ]; then
            echo "proceed=true" >> $GITHUB_OUTPUT
            echo "::notice::æ£€æµ‹åˆ°ä¸Šæ¸¸æ›´æ–° - å¼€å§‹åŒæ­¥"
          else
            echo "proceed=false" >> $GITHUB_OUTPUT
            echo "::notice::ä¸Šæ¸¸æ— æ›´æ–° - è·³è¿‡åŒæ­¥"
          fi

      # ========== ä»¥ä¸‹æ­¥éª¤ä»…åœ¨éœ€è¦æ—¶æ‰§è¡Œ ==========

      - name: Backup workflow file
        if: steps.should_proceed.outputs.proceed == 'true'
        run: |
          WORKFLOW_FILE=".github/workflows/mydiywode.yml"
          if [ -f "$WORKFLOW_FILE" ]; then
            echo "ğŸ“¦ å¤‡ä»½å·¥ä½œæµæ–‡ä»¶åˆ° /tmp..."
            cp "$WORKFLOW_FILE" /tmp/mydiywode.yml.backup
            echo "âœ… å¤‡ä»½å®Œæˆ"
          else
            echo "::error::å·¥ä½œæµæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•å¤‡ä»½"
            exit 1
          fi

      - name: Force sync to upstream (discard all local changes)
        if: steps.should_proceed.outputs.proceed == 'true'
        run: |
          echo "âš™ï¸ å¼ºåˆ¶åŒæ­¥åˆ°ä¸Šæ¸¸ç‰ˆæœ¬ï¼ˆä¸¢å¼ƒæ‰€æœ‰æœ¬åœ°æ›´æ”¹ï¼‰"
          git checkout main
          git reset --hard upstream/main
          echo "âœ… å·²å®Œå…¨åŒæ­¥åˆ°ä¸Šæ¸¸ç‰ˆæœ¬"
          git log --oneline -3

      - name: Restore workflow file
        if: steps.should_proceed.outputs.proceed == 'true'
        run: |
          WORKFLOW_FILE=".github/workflows/mydiywode.yml"
          if [ -f /tmp/mydiywode.yml.backup ]; then
            echo "â™»ï¸ æ¢å¤å·¥ä½œæµæ–‡ä»¶..."
            mkdir -p .github/workflows
            cp /tmp/mydiywode.yml.backup "$WORKFLOW_FILE"
            echo "âœ… å·¥ä½œæµæ–‡ä»¶å·²æ¢å¤"
          else
            echo "::error::æœªæ‰¾åˆ°å¤‡ä»½æ–‡ä»¶"
            exit 1
          fi

      - name: Apply modifications to Scripts/diy.sh
        if: steps.should_proceed.outputs.proceed == 'true'
        run: |
          TARGET="Scripts/diy.sh"
          
          if [ ! -f "$TARGET" ]; then
            echo "::warning::ç›®æ ‡æ–‡ä»¶ $TARGET ä¸å­˜åœ¨ - è·³è¿‡ä¿®æ”¹"
            exit 0
          fi

          echo "1ï¸âƒ£ æ£€æŸ¥å¹¶æ·»åŠ  PPP/UPnP ä¿®å¤è„šæœ¬..."
          if grep -q 'Fix PPP / UPnP issues' "$TARGET"; then
            echo "â„¹ï¸ PPP/UPnP ä¿®å¤è„šæœ¬å·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ "
          else
            {
              echo ""
              echo "#######################################"
              echo "# Fix PPP / UPnP issues"
              echo "#######################################"
              echo "mkdir -p package/base-files/files/etc/uci-defaults"
              echo "cat << 'EOF' > package/base-files/files/etc/uci-defaults/99-custom-fixes"
              echo "#!/bin/sh"
              echo "sed -i '8c maxfail 1' /etc/ppp/options"
              echo "sed -i '192c sleep 30' /lib/netifd/proto/ppp.sh"
              echo "sed -i '10c option external_ip \"59.111.160.244\"' /etc/config/upnpd"
              echo "exit 0"
              echo "EOF"
              echo "chmod +x package/base-files/files/etc/uci-defaults/99-custom-fixes"
            } >> "$TARGET"
            echo "âœ… PPP/UPnP ä¿®å¤è„šæœ¬å·²æ·»åŠ "
          fi

      - name: Apply modifications to Scripts/diy.sh (add plugins to array)
        if: steps.should_proceed.outputs.proceed == 'true'
        run: |
          TARGET="Scripts/diy.sh"
          
          if [ ! -f "$TARGET" ]; then
            echo "::warning::ç›®æ ‡æ–‡ä»¶ $TARGET ä¸å­˜åœ¨ - è·³è¿‡æ’ä»¶é…ç½®"
            exit 0
          fi

          echo "2ï¸âƒ£ åœ¨ç¬¬ä¸€ä¸ª provided_config_lines æ•°ç»„ä¸­æ·»åŠ æ’ä»¶..."
          
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨ provided_config_lines æ•°ç»„
          if ! grep -q "provided_config_lines=(" "$TARGET"; then
            echo "::warning::æœªæ‰¾åˆ° provided_config_lines æ•°ç»„ï¼Œè·³è¿‡"
            exit 0
          fi
          
          # æ£€æŸ¥æ’ä»¶æ˜¯å¦å·²å­˜åœ¨
          if grep -q "CONFIG_PACKAGE_luci-app-mosdns=y" "$TARGET" && \
             grep -q "CONFIG_PACKAGE_luci-app-wolplus=y" "$TARGET"; then
            echo "â„¹ï¸ æ’ä»¶é…ç½®å·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ "
          else
            # ä½¿ç”¨ awk åªåœ¨ç¬¬ä¸€ä¸ª provided_config_lines=( å—çš„æœ€å ) ä¹‹å‰æ’å…¥
            awk '
            BEGIN { in_first_array=0; found_first=0 }
            /^provided_config_lines=\(/ && found_first==0 { 
              in_first_array=1
              found_first=1
              print
              next
            }
            /^\)$/ && in_first_array==1 {
              print "    \"CONFIG_PACKAGE_luci-app-mosdns=y\""
              print "    \"CONFIG_PACKAGE_luci-app-wolplus=y\""
              in_first_array=0
            }
            { print }
            ' "$TARGET" > "$TARGET.tmp" && mv "$TARGET.tmp" "$TARGET"
            
            echo "âœ… å·²æ·»åŠ  luci-app-mosdns å’Œ luci-app-wolplus åˆ°ç¬¬ä¸€ä¸ªé…ç½®æ•°ç»„"
          fi

      - name: ä¿®æ”¹ QCA-ALL.yml æ–‡ä»¶ä¸­çš„é»˜è®¤ IP åœ°å€
        if: steps.should_proceed.outputs.proceed == 'true'
        run: |
          FILE=".github/workflows/QCA-ALL.yml"
          if [ -f "$FILE" ]; then
            echo "ğŸ”§ ä¿®æ”¹ $FILE ä¸­çš„é»˜è®¤ IP åœ°å€..."
            sed -i "s/WRT_IP: 192\.168\.10\.1/WRT_IP: 192\.168\.1\.2/g" "$FILE"
            echo "âœ… å·²ä¿®æ”¹ WRT_IP åœ°å€ä¸º 192.168.1.2"
          else
            echo "::error::$FILE æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•ä¿®æ”¹ IP åœ°å€"
            exit 1
          fi

      - name: Commit all changes
        if: steps.should_proceed.outputs.proceed == 'true'
        id: commit_changes
        run: |
          git add -A
          
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "chore: sync upstream and apply custom modifications" \
                       -m "- Synced with upstream/main" \
                       -m "- Restored workflow file" \
                       -m "- Applied PPP/UPnP fixes" \
                       -m "- Added custom plugins to .config" \
                       -m "" \
                       -m "[skip ci]"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… å·²æäº¤æ‰€æœ‰æ›´æ”¹"
          fi

      - name: Push to origin
        if: steps.should_proceed.outputs.proceed == 'true' && steps.commit_changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸš€ æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“..."
          # ä½¿ç”¨ --force-with-lease æ›´å®‰å…¨ï¼Œå¦‚æœè¿œç¨‹æœ‰å…¶ä»–äººçš„æäº¤ä¼šå¤±è´¥
          git push origin main --force-with-lease || {
            echo "::warning::force-with-lease å¤±è´¥ï¼Œå°è¯• force push..."
            git push origin main --force
          }
          echo "âœ… å·²æˆåŠŸæ¨é€åˆ° origin/main"

      - name: Disable OWRT-ALL workflow
        if: steps.should_proceed.outputs.proceed == 'true'
        env:
          TOKEN: ${{ secrets.PAT_TOKEN != '' && secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          WF_NAME="OWRT-ALL"

          if [ -z "$TOKEN" ]; then
            echo "::warning::æœªæä¾› tokenï¼Œè·³è¿‡ç¦ç”¨å·¥ä½œæµ"
            exit 0
          fi

          echo "ğŸ” æŸ¥æ‰¾å·¥ä½œæµ: $WF_NAME"
          response=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/actions/workflows")
          
          http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
          body=$(echo "$response" | sed '/HTTP_CODE:/d')
          
          if [ "$http_code" != "200" ]; then
            echo "::warning::API è¯·æ±‚å¤±è´¥ (HTTP $http_code)"
            exit 0
          fi

          WF_ID=$(echo "$body" | jq -r ".workflows[] | select(.name==\"${WF_NAME}\") | .id")
          
          if [ -z "$WF_ID" ] || [ "$WF_ID" = "null" ]; then
            echo "::warning::æœªæ‰¾åˆ°å·¥ä½œæµ '$WF_NAME'"
            exit 0
          fi

          echo "æ‰¾åˆ°å·¥ä½œæµ ID: $WF_ID"
          echo "ğŸš« ç¦ç”¨å·¥ä½œæµ..."
          
          disable_response=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X PUT \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/actions/workflows/${WF_ID}/disable")
          
          disable_code=$(echo "$disable_response" | grep "HTTP_CODE:" | cut -d: -f2)
          
          if [ "$disable_code" = "204" ]; then
            echo "âœ… å·¥ä½œæµ '$WF_NAME' å·²æˆåŠŸç¦ç”¨"
          else
            echo "::warning::ç¦ç”¨å¤±è´¥ (HTTP $disable_code)"
          fi

      - name: Summary
        if: always()
        run: |
          echo "======================================"
          echo "           æ‰§ è¡Œ æ‘˜ è¦"
          echo "======================================"
          echo ""
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo ""
          
          if [ "${{ steps.should_proceed.outputs.proceed }}" != "true" ]; then
            echo "ğŸ“‹ ç»“æœ: ä¸Šæ¸¸æ— æ›´æ–°ï¼Œè·³è¿‡åŒæ­¥"
          else
            echo "ğŸ“‹ æ‰§è¡Œç»“æœ:"
            echo "  âœ… å·²å¼ºåˆ¶åŒæ­¥åˆ°ä¸Šæ¸¸ç‰ˆæœ¬"
            echo "  âœ… å·²æ¢å¤å·¥ä½œæµæ–‡ä»¶"
            echo "  âœ… å·²åº”ç”¨è‡ªå®šä¹‰ä¿®æ”¹"
            
            if [ "${{ steps.commit_changes.outputs.has_changes }}" = "true" ]; then
              echo "  âœ… æ›´æ”¹å·²æäº¤å¹¶æ¨é€"
            else
              echo "  â„¹ï¸ æ— æ–°æ›´æ”¹éœ€è¦æäº¤"
            fi
          fi
          echo ""
          echo "======================================"
